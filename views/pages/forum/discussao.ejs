<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/pages/forum/style/discussao.css">
</head>
    <p id="titulo-categoria-discussao" style="text-align: start; font-style: italic; margin-bottom: 1rem;"></p>
    <!-- Discussão -->
    <section class="see-thread" id="see-thread">
        <div class="postarea" id="postarea">
        </div>
    </section>
    <!-- Area de envio de post -->
    <section class="send-messagearea">
        <input type="text" id="writePost" placeholder="Escrever post..." required>
        <button id="post">Publicar</button>
    </section>
<script>
function renderPosts(posts) {
  const messagesDiv = document.getElementById('postarea');
  messagesDiv.innerHTML = ''; // Limpa os posts existentes

  if (posts.length === 0) {
    messagesDiv.innerHTML = '<div class="post">Nenhum post publicado ainda.</div>';
    return;
  }

  posts.forEach(post => {
    const postDiv = document.createElement('div');
    postDiv.classList.add('post');
    
    // Garantir que o timestamp seja um objeto Date
    const timestamp = new Date(post.timestamp); // Converte o timestamp para Date
    const tempoFormatado = `${timestamp.toLocaleDateString()} ${timestamp.toLocaleTimeString()}`;
    
    postDiv.innerHTML = `
      <div class="post-text">
        ${post.text}
      </div>
      <div>
        <p class="post-info"><strong>${post.userTag}</strong></p>
        <p class="post-info">${tempoFormatado}</p>
      </div>
    `;
    
    messagesDiv.appendChild(postDiv);
  });

  // Fazer a rolagem ir para o final
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Conectar ao servidor de mensagens
function listenForPosts(categoria, discussao) {
  console.log(`Escutando posts na categoria ${categoria} e discussão ${discussao}`);
    if (!categoria || !discussao) {
        console.error('categoria e discussao são necessários para escutar mensagens.');
        return;
    }

    // Conectar ao servidor de mensagens com parâmetros na URL
    const eventSource = new EventSource(`/stream-posts?categoria=${categoria}&discussao=${discussao}`);
    
    eventSource.onmessage = (event) => {
        try {
        const posts = JSON.parse(event.data);
        console.log(posts);
        renderPosts(posts); // Renderizar as mensagens no frontend
        } catch (error) {
        console.error('Erro ao processar os dados recebidos:', error);
        }
    };

    eventSource.onerror = (error) => {
        eventSource.close();
    };
}

// Postar novo post
document.getElementById('post').addEventListener('click', async () => {
    const text = document.getElementById('writePost').value.trim();
    const userTag = localStorage.getItem("autenticationUserTag");
    if (!text) {
      document.getElementById('statusMessage').textContent = 'O post não pode estar vazio.';
      return;
    }

    try {
      const response = await fetch(`/posts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, categoria, discussao, userTag }),
      });

      const responseData = await response.json();
      if (response.ok) {
        console.log(`Post publicada com sucesso.`);
        document.getElementById('writePost').value = ''; // Limpar o campo de entrada
      } else {
        console.log(`responseData.error || 'Erro ao publicar.`);
      }
    } catch (error) {
      console.log(`Erro: ${error.message}`);
    }
});

// Declarando as variáveis fora do escopo da função
let categoria;
let discussao;

window.onload = () => {
    document.getElementById('writePost').value = ''; // Limpar o campo de entrada

    // Recuperando os parâmetros da URL
    const urlParams = new URLSearchParams(window.location.search);

    // Atribuindo os valores recuperados nas variáveis globais
    categoria = urlParams.get('categoria');
    discussao = urlParams.get('discussao');

    // Adiciona titulo à página
    document.getElementById("titulo-categoria-discussao").innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
          <!-- Botão com SVG -->
          <button id="back-button" onclick="window.location.href='/forum?categoria=${categoria}'">
            <svg fill="#000000" height="16px" width="16px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
              viewBox="0 0 26.676 26.676" xml:space="preserve" style="margin-right: 5px;">
              <path d="M26.105,21.891c-0.229,0-0.439-0.131-0.529-0.346l0,0c-0.066-0.156-1.716-3.857-7.885-4.59
                c-1.285-0.156-2.824-0.236-4.693-0.25v4.613c0,0.213-0.115,0.406-0.304,0.508c-0.188,0.098-0.413,0.084-0.588-0.033L0.254,13.815
                C0.094,13.708,0,13.528,0,13.339c0-0.191,0.094-0.365,0.254-0.477l11.857-7.979c0.175-0.121,0.398-0.129,0.588-0.029
                c0.19,0.102,0.303,0.295,0.303,0.502v4.293c2.578,0.336,13.674,2.33,13.674,11.674c0,0.271-0.191,0.508-0.459,0.562
                C26.18,21.891,26.141,21.891,26.105,21.891z"/>
            </svg>
          </button>
          
          <!-- Texto com categoria e discussão -->
          <strong style="font-size: 18px;">
            <a href="/forum?categoria=${categoria}" style="color: inherit; text-decoration: underline; text-decoration-color: currentColor;">${categoria}</a> / ${discussao}
          </strong>
        </div>
    `;

    // Chama a função listenForPosts com os parâmetros
    listenForPosts(categoria, discussao);
};
</script>